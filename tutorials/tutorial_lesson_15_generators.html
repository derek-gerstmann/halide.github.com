<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<title>
 Generators part 1
</title>
<link rel="stylesheet" type="text/css" href="../assets/css/highlight.css">
<style>

a:visited {
color: #000000;
}

a:link {
color: #000000;
}

a:hover {
color: #aa0000;
}

</style>
</head>
<body class="hl" style="background-color: #444444; font-family: Helvetica, Arial, sans-serif;">
<script>
function toggle(id) {
    e = document.getElementById(id);
    show = document.getElementById(id + '-show');
    if (e.style.display != 'none') {
        e.style.display = 'none';
        show.innerHTML = "// Click to show output ...";
    } else {
        e.style.display = 'block';
        show.innerHTML = "// Click to hide output ...";
    }
    return false;
}
</script>
<div>
<style scoped>
@import "../assets/css/bootstrap.css";
</style>
<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <a class="brand" href="/index.html">Halide</a>
      <div class="nav-collapse">
        <ul class="nav">
          <li><a href="/index.html#gettingstarted">Getting Started</a></li>
          <li><a href="/tutorials/tutorial_introduction.html">Tutorials</a></li>
          <li><a href="/index.html#publications">Publications</a></li>
          <li><a href="/index.html#resources">Resources</a></li>
          <li class="divider-vertical"></li>
          <li><a href="/docs">Docs</a></li>
          <li><a href="http://github.com/halide/Halide/issues">Bugs</a></li>
          <li><a href="http://github.com/halide/Halide/wiki">Wiki</a></li>
          <li class="divider-vertical"></li>
          <li><a href="http://stackoverflow.com/questions/tagged/halide"><i class="fa fa-stack-overflow"></i>/#halide</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>
</div>

<div style='position:relative; width:900pt; top:60px;'>
<div style="width:200px; float:left; ">
<a href="tutorial_introduction.html" style="text-decoration:none;" ><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px;
background-color: #dddddd; 
text-align: left; ">
<b>
00
&nbsp</b>
Introduction
</div>
</span>
</a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_01_basics.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
01
&nbsp</b>
 Getting started with Funcs, Vars, and Exprs
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_02_input_image.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
02
&nbsp</b>
 Processing images
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_03_debugging_1.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
03
&nbsp</b>
 Inspecting the generated code
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_04_debugging_2.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
04
&nbsp</b>
 Debugging with tracing, print, and print_when
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_05_scheduling_1.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
05
&nbsp</b>
 Vectorize, parallelize, unroll and tile your code
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_06_realizing_over_shifted_domains.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
06
&nbsp</b>
 Realizing Funcs over arbitrary domains
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_07_multi_stage_pipelines.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
07
&nbsp</b>
 Multi-stage pipelines
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_08_scheduling_2.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
08
&nbsp</b>
 Scheduling multi-stage pipelines
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_09_update_definitions.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
09
&nbsp</b>
 Multi-pass Funcs, update definitions, and reductions
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_10_aot_compilation_generate.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
10
&nbsp</b>
 AOT compilation part 1
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_10_aot_compilation_run.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
10
&nbsp</b>
 AOT compilation part 2
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_11_cross_compilation.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
11
&nbsp</b>
 Cross-compilation
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_12_using_the_gpu.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
12
&nbsp</b>
 Using the GPU
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_13_tuples.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
13
&nbsp</b>
 Tuples
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_14_types.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
14
&nbsp</b>
 The Halide type system
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_15_generators.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; padding-right:40px; background-color: #ffffff; color: #000000; text-align: left; ">
<b>
15
&nbsp</b>
 Generators part 1
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_15_generators_usage.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
15
&nbsp</b>
 Generators part 2
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_16_rgb_generate.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
16
&nbsp</b>
 RGB images and memory layouts part 1
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_16_rgb_run.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
16
&nbsp</b>
 RGB images and memory layouts part 2
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_17_predicated_rdom.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
17
&nbsp</b>
 Reductions over non-rectangular domains
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_18_parallel_associative_reductions.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
18
&nbsp</b>
 Factoring an associative reduction using rfactor
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_19_wrapper_funcs.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
19
&nbsp</b>
 Wrapper Funcs
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_20_cloning_funcs.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
20
&nbsp</b>
 Cloning Funcs
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_21_auto_scheduler_generate.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
21
&nbsp</b>
 Auto-Scheduler
</div></span></a>
<div style="width:200px; height:20px;"></div>
<a href=
tutorial_lesson_21_auto_scheduler_run.html
 style="text-decoration:none;"><span style="width:100%; height:100%; top:0; left:0;">
<div style="width:200px; padding:20px; background-color: #dddddd; text-align: left; ">
<b>
21
&nbsp</b>
 Auto-Scheduler
</div></span></a>
</div>
<div style="position:relative; margin-left:260px; padding:20px; background-color: #ffffff;">
<pre class="hl">
<span class="hl slc">// Halide tutorial lesson 15: Generators part 1</span>

<span class="hl slc">// This lesson demonstrates how to encapsulate Halide pipelines into</span>
<span class="hl slc">// reusable components called generators.</span>

<span class="hl slc">// On linux, you can compile and run it like so:</span>
<span class="hl slc">// g++ lesson_15*.cpp &lt;path/to/tools/halide_image_io.h&gt;/GenGen.cpp -g -std=c++17 -fno-rtti -I &lt;path/to/Halide.h&gt; -L &lt;path/to/libHalide.so&gt; -lHalide -lpthread -ldl -o lesson_15_generate</span>
<span class="hl slc">// bash lesson_15_generators_usage.sh</span>

<span class="hl slc">// On os x:</span>
<span class="hl slc">// g++ lesson_15*.cpp &lt;path/to/tools/halide_image_io.h&gt;/GenGen.cpp -g -std=c++17 -fno-rtti -I &lt;path/to/Halide.h&gt; -L &lt;path/to/libHalide.so&gt; -lHalide -o lesson_15_generate</span>
<span class="hl slc">// bash lesson_15_generators_usage.sh</span>

<span class="hl slc">// If you have the entire Halide source tree, you can also build it by</span>
<span class="hl slc">// running:</span>
<span class="hl slc">//    make tutorial_lesson_15_generators</span>
<span class="hl slc">// in a shell with the current directory at the top of the halide</span>
<span class="hl slc">// source tree.</span>

<span class="hl ppc">#include</span> <span class="hl pps">&quot;Halide.h&quot;</span><span class="hl ppc"></span>
<span class="hl ppc">#include &lt;stdio.h&gt;</span>

<span class="hl kwa">using namespace</span> Halide<span class="hl opt">;</span>

<span class="hl slc">// Generators are a more structured way to do ahead-of-time</span>
<span class="hl slc">// compilation of Halide pipelines. Instead of writing an int main()</span>
<span class="hl slc">// with an ad-hoc command-line interface like we did in lesson 10, we</span>
<span class="hl slc">// define a class that inherits from Halide::Generator.</span>
<span class="hl kwc">class</span> MyFirstGenerator <span class="hl opt">:</span> <span class="hl kwc">public Halide</span><span class="hl opt">::</span>Generator<span class="hl opt">&lt;</span>MyFirstGenerator<span class="hl opt">&gt; {</span>
<span class="hl kwc">public</span><span class="hl opt">:</span>
    <span class="hl slc">// We declare the Inputs to the Halide pipeline as public</span>
    <span class="hl slc">// member variables. They&apos;ll appear in the signature of our generated</span>
    <span class="hl slc">// function in the same order as we declare them.</span>
    Input<span class="hl opt">&lt;</span><span class="hl kwb">uint8_t</span><span class="hl opt">&gt;</span> offset<span class="hl opt">{</span><span class="hl str">&quot;offset&quot;</span><span class="hl opt">};</span>
    Input<span class="hl opt">&lt;</span>Buffer<span class="hl opt">&lt;</span><span class="hl kwb">uint8_t</span><span class="hl opt">&gt;&gt;</span> input<span class="hl opt">{</span><span class="hl str">&quot;input&quot;</span><span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">};</span>

    <span class="hl slc">// We also declare the Outputs as public member variables.</span>
    Output<span class="hl opt">&lt;</span>Buffer<span class="hl opt">&lt;</span><span class="hl kwb">uint8_t</span><span class="hl opt">&gt;&gt;</span> brighter<span class="hl opt">{</span><span class="hl str">&quot;brighter&quot;</span><span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">};</span>

    <span class="hl slc">// Typically you declare your Vars at this scope as well, so that</span>
    <span class="hl slc">// they can be used in any helper methods you add later.</span>
    Var x<span class="hl opt">,</span> y<span class="hl opt">;</span>

    <span class="hl slc">// We then define a method that constructs and return the Halide</span>
    <span class="hl slc">// pipeline:</span>
    <span class="hl kwb">void</span> <span class="hl kwd">generate</span><span class="hl opt">() {</span>
        <span class="hl slc">// In lesson 10, here is where we called</span>
        <span class="hl slc">// Func::compile_to_file. In a Generator, we just need to</span>
        <span class="hl slc">// define the Output(s) representing the output of the pipeline.</span>
        <span class="hl kwd">brighter</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">input</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) +</span> offset<span class="hl opt">;</span>

        <span class="hl slc">// Schedule it.</span>
        brighter<span class="hl opt">.</span><span class="hl kwd">vectorize</span><span class="hl opt">(</span>x<span class="hl opt">,</span> <span class="hl num">16</span><span class="hl opt">).</span><span class="hl kwd">parallel</span><span class="hl opt">(</span>y<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

<span class="hl slc">// We compile this file along with tools/GenGen.cpp. That file defines</span>
<span class="hl slc">// an &quot;int main(...)&quot; that provides the command-line interface to use</span>
<span class="hl slc">// your generator class. We need to tell that code about our</span>
<span class="hl slc">// generator. We do this like so:</span>
<span class="hl kwd">HALIDE_REGISTER_GENERATOR</span><span class="hl opt">(</span>MyFirstGenerator<span class="hl opt">,</span> my_first_generator<span class="hl opt">)</span>

<span class="hl slc">// If you like, you can put multiple Generators in the one file. This</span>
<span class="hl slc">// could be a good idea if they share some common code. Let&apos;s define</span>
<span class="hl slc">// another more complex generator:</span>
<span class="hl kwc">class</span> MySecondGenerator <span class="hl opt">:</span> <span class="hl kwc">public Halide</span><span class="hl opt">::</span>Generator<span class="hl opt">&lt;</span>MySecondGenerator<span class="hl opt">&gt; {</span>
<span class="hl kwc">public</span><span class="hl opt">:</span>
    <span class="hl slc">// This generator will take some compile-time parameters</span>
    <span class="hl slc">// too. These let you compile multiple variants of a Halide</span>
    <span class="hl slc">// pipeline. We&apos;ll define one that tells us whether or not to</span>
    <span class="hl slc">// parallelize in our schedule:</span>
    GeneratorParam<span class="hl opt">&lt;</span><span class="hl kwb">bool</span><span class="hl opt">&gt;</span> parallel<span class="hl opt">{</span><span class="hl str">&quot;parallel&quot;</span><span class="hl opt">,</span> <span class="hl com">/* default value */</span> <span class="hl kwa">true</span><span class="hl opt">};</span>

    <span class="hl slc">// ... and another representing a constant scale factor to use:</span>
    GeneratorParam<span class="hl opt">&lt;</span><span class="hl kwb">float</span><span class="hl opt">&gt;</span> scale<span class="hl opt">{</span><span class="hl str">&quot;scale&quot;</span><span class="hl opt">,</span>
                                <span class="hl num">1.0</span>f <span class="hl com">/* default value */</span><span class="hl opt">,</span>
                                <span class="hl num">0.0</span>f <span class="hl com">/* minimum value */</span><span class="hl opt">,</span>
                                <span class="hl num">100.0</span>f <span class="hl com">/* maximum value */</span><span class="hl opt">};</span>

    <span class="hl slc">// You can define GeneratorParams of all the basic scalar</span>
    <span class="hl slc">// types. For numeric types you can optionally provide a minimum</span>
    <span class="hl slc">// and maximum value, as we did for scale above.</span>

    <span class="hl slc">// You can also define GeneratorParams for enums. To make this</span>
    <span class="hl slc">// work you must provide a mapping from strings to your enum</span>
    <span class="hl slc">// values.</span>
    <span class="hl kwb">enum</span> <span class="hl kwc">class</span> Rotation <span class="hl opt">{</span> None<span class="hl opt">,</span>
                          Clockwise<span class="hl opt">,</span>
                          CounterClockwise <span class="hl opt">};</span>
    GeneratorParam<span class="hl opt">&lt;</span>Rotation<span class="hl opt">&gt;</span> rotation<span class="hl opt">{</span><span class="hl str">&quot;rotation&quot;</span><span class="hl opt">,</span>
                                      <span class="hl com">/* default value */</span>
                                      <span class="hl kwc">Rotation</span><span class="hl opt">::</span>None<span class="hl opt">,</span>
                                      <span class="hl com">/* map from names to values */</span>
                                      <span class="hl opt">{{</span><span class="hl str">&quot;none&quot;</span><span class="hl opt">,</span> <span class="hl kwc">Rotation</span><span class="hl opt">::</span>None<span class="hl opt">},</span>
                                       <span class="hl opt">{</span><span class="hl str">&quot;cw&quot;</span><span class="hl opt">,</span> <span class="hl kwc">Rotation</span><span class="hl opt">::</span>Clockwise<span class="hl opt">},</span>
                                       <span class="hl opt">{</span><span class="hl str">&quot;ccw&quot;</span><span class="hl opt">,</span> <span class="hl kwc">Rotation</span><span class="hl opt">::</span>CounterClockwise<span class="hl opt">}}};</span>

    <span class="hl slc">// We&apos;ll use the same Inputs as before:</span>
    Input<span class="hl opt">&lt;</span><span class="hl kwb">uint8_t</span><span class="hl opt">&gt;</span> offset<span class="hl opt">{</span><span class="hl str">&quot;offset&quot;</span><span class="hl opt">};</span>
    Input<span class="hl opt">&lt;</span>Buffer<span class="hl opt">&lt;</span><span class="hl kwb">uint8_t</span><span class="hl opt">&gt;&gt;</span> input<span class="hl opt">{</span><span class="hl str">&quot;input&quot;</span><span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">};</span>

    <span class="hl slc">// And a similar Output. Note that we don&apos;t specify a type for the Buffer:</span>
    <span class="hl slc">// at compile-time, we must specify an explicit type via the &quot;output.type&quot;</span>
    <span class="hl slc">// GeneratorParam (which is implicitly defined for this Output).</span>
    Output<span class="hl opt">&lt;</span>Buffer<span class="hl opt">&lt;&gt;&gt;</span> output<span class="hl opt">{</span><span class="hl str">&quot;output&quot;</span><span class="hl opt">,</span> <span class="hl num">2</span><span class="hl opt">};</span>

    <span class="hl slc">// And we&apos;ll declare our Vars here as before.</span>
    Var x<span class="hl opt">,</span> y<span class="hl opt">;</span>

    <span class="hl kwb">void</span> <span class="hl kwd">generate</span><span class="hl opt">() {</span>
        <span class="hl slc">// Define the Func. We&apos;ll use the compile-time scale factor as</span>
        <span class="hl slc">// well as the runtime offset param.</span>
        Func brighter<span class="hl opt">;</span>
        <span class="hl kwd">brighter</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> scale <span class="hl opt">* (</span><span class="hl kwd">input</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) +</span> offset<span class="hl opt">);</span>

        <span class="hl slc">// We&apos;ll possibly do some sort of rotation, depending on the</span>
        <span class="hl slc">// enum. To get the value of a GeneratorParam, cast it to the</span>
        <span class="hl slc">// corresponding type. This cast happens implicitly most of</span>
        <span class="hl slc">// the time (e.g. with scale above).</span>

        Func rotated<span class="hl opt">;</span>
        <span class="hl kwa">switch</span> <span class="hl opt">((</span>Rotation<span class="hl opt">)</span>rotation<span class="hl opt">) {</span>
        <span class="hl kwa">case</span> <span class="hl kwc">Rotation</span><span class="hl opt">::</span>None<span class="hl opt">:</span>
            <span class="hl kwd">rotated</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">brighter</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">);</span>
            <span class="hl kwa">break</span><span class="hl opt">;</span>
        <span class="hl kwa">case</span> <span class="hl kwc">Rotation</span><span class="hl opt">::</span>Clockwise<span class="hl opt">:</span>
            <span class="hl kwd">rotated</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">brighter</span><span class="hl opt">(</span>y<span class="hl opt">,</span> <span class="hl num">100</span> <span class="hl opt">-</span> x<span class="hl opt">);</span>
            <span class="hl kwa">break</span><span class="hl opt">;</span>
        <span class="hl kwa">case</span> <span class="hl kwc">Rotation</span><span class="hl opt">::</span>CounterClockwise<span class="hl opt">:</span>
            <span class="hl kwd">rotated</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">brighter</span><span class="hl opt">(</span><span class="hl num">100</span> <span class="hl opt">-</span> y<span class="hl opt">,</span> x<span class="hl opt">);</span>
            <span class="hl kwa">break</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>

        <span class="hl slc">// We&apos;ll then cast to the desired output type.</span>
        <span class="hl kwd">output</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">) =</span> <span class="hl kwd">cast</span><span class="hl opt">(</span>output<span class="hl opt">.</span><span class="hl kwd">type</span><span class="hl opt">(),</span> <span class="hl kwd">rotated</span><span class="hl opt">(</span>x<span class="hl opt">,</span> y<span class="hl opt">));</span>

        <span class="hl slc">// The structure of the pipeline depended on the generator</span>
        <span class="hl slc">// params. So will the schedule.</span>

        <span class="hl slc">// Let&apos;s start by vectorizing the output. We don&apos;t know the</span>
        <span class="hl slc">// type though, so it&apos;s hard to pick a good factor. Generators</span>
        <span class="hl slc">// provide a helper called &quot;natural_vector_size&quot; which will</span>
        <span class="hl slc">// pick a reasonable factor for you given the type and the</span>
        <span class="hl slc">// target you&apos;re compiling to.</span>
        output<span class="hl opt">.</span><span class="hl kwd">vectorize</span><span class="hl opt">(</span>x<span class="hl opt">,</span> <span class="hl kwd">natural_vector_size</span><span class="hl opt">(</span>output<span class="hl opt">.</span><span class="hl kwd">type</span><span class="hl opt">()));</span>

        <span class="hl slc">// Now we&apos;ll possibly parallelize it:</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>parallel<span class="hl opt">) {</span>
            output<span class="hl opt">.</span><span class="hl kwd">parallel</span><span class="hl opt">(</span>y<span class="hl opt">);</span>
        <span class="hl opt">}</span>

        <span class="hl slc">// If there was a rotation, we&apos;ll schedule that to occur per</span>
        <span class="hl slc">// scanline of the output and vectorize it according to its</span>
        <span class="hl slc">// type.</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>rotation <span class="hl opt">!=</span> <span class="hl kwc">Rotation</span><span class="hl opt">::</span>None<span class="hl opt">) {</span>
            rotated
                <span class="hl opt">.</span><span class="hl kwd">compute_at</span><span class="hl opt">(</span>output<span class="hl opt">,</span> y<span class="hl opt">)</span>
                <span class="hl opt">.</span><span class="hl kwd">vectorize</span><span class="hl opt">(</span>x<span class="hl opt">,</span> <span class="hl kwd">natural_vector_size</span><span class="hl opt">(</span>rotated<span class="hl opt">.</span><span class="hl kwd">output_types</span><span class="hl opt">()[</span><span class="hl num">0</span><span class="hl opt">]));</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">};</span>

<span class="hl slc">// Register our second generator:</span>
<span class="hl kwd">HALIDE_REGISTER_GENERATOR</span><span class="hl opt">(</span>MySecondGenerator<span class="hl opt">,</span> my_second_generator<span class="hl opt">)</span>

<span class="hl slc">// After compiling this file, see how to use it in</span>
<span class="hl slc">// lesson_15_generators_build.sh</span>
</pre>
</div></body></html>
